# üöÄ Gu√≠a: Workspace Colaborativo con Autenticaci√≥n

## üéØ Arquitectura Correcta

### ‚ùå Problema Anterior
```
Usuario A ‚Üí files_LOCAL_A (localStorage)
Usuario B ‚Üí files_LOCAL_B (localStorage)
    ‚Üì Solo broadcasting ‚ùå
Sin fuente √∫nica de verdad
```

### ‚úÖ Soluci√≥n Nueva
```
Usuario A (autenticado)  ‚îê
Usuario B (autenticado)  ‚îú‚îÄ‚Üí  SUPABASE DATABASE
Usuario C (autenticado)  ‚îò     (Single Source of Truth)
                              ‚úÖ Todos editan lo mismo
```

---

## üìã Paso 1: Configurar Supabase Auth

### 1.1 Habilitar Autenticaci√≥n

1. Ve a tu proyecto de Supabase
2. Men√∫ lateral ‚Üí **Authentication** ‚Üí **Providers**
3. Habilita:
   - ‚úÖ **Email** (activado por defecto)
   - ‚úÖ **Google** (opcional, recomendado)
   - ‚úÖ **GitHub** (opcional, recomendado)

### 1.2 Configurar Google OAuth (Opcional)

1. Ve a [Google Cloud Console](https://console.cloud.google.com/)
2. Crea un proyecto nuevo
3. Habilita "Google+ API"
4. Credenciales ‚Üí Crear credenciales ‚Üí ID de cliente OAuth 2.0
5. **Or√≠genes autorizados**:
   ```
   http://localhost:3001
   https://tu-dominio.com
   ```
6. **URIs de redirecci√≥n autorizadas**:
   ```
   https://tu-proyecto.supabase.co/auth/v1/callback
   ```
7. Copia **Client ID** y **Client Secret**
8. P√©galos en Supabase ‚Üí Authentication ‚Üí Providers ‚Üí Google

### 1.3 Configurar GitHub OAuth (Opcional)

1. Ve a GitHub ‚Üí Settings ‚Üí Developer settings ‚Üí OAuth Apps
2. New OAuth App
3. **Homepage URL**: `http://localhost:3001`
4. **Authorization callback URL**: 
   ```
   https://tu-proyecto.supabase.co/auth/v1/callback
   ```
5. Copia **Client ID** y **Client Secret**
6. P√©galos en Supabase ‚Üí Authentication ‚Üí Providers ‚Üí GitHub

---

## üìã Paso 2: Crear Esquema de Base de Datos

### 2.1 Ejecutar SQL

1. Abre Supabase ‚Üí **SQL Editor**
2. Copia el contenido de `supabase-workspace-schema.sql`
3. Clic en **Run** o `Ctrl + Enter`

Esto crear√°:
- ‚úÖ `collaborative_sessions` - Sesiones compartidas
- ‚úÖ `session_participants` - Usuarios conectados
- ‚úÖ `workspace_files` - Archivos remotos (SINGLE SOURCE OF TRUTH)
- ‚úÖ `file_changes_log` - Historial de cambios
- ‚úÖ `cursor_positions` - Posiciones de cursores
- ‚úÖ Row Level Security (RLS) - Seguridad
- ‚úÖ Triggers autom√°ticos

### 2.2 Verificar Tablas Creadas

```sql
-- En SQL Editor de Supabase
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public'
ORDER BY table_name;
```

Deber√≠as ver las 5 tablas creadas.

---

## üìã Paso 3: Actualizar Variables de Entorno

### 3.1 Archivo `.env`

```env
# Supabase (existente)
VITE_SUPABASE_URL=https://tu-proyecto.supabase.co
VITE_SUPABASE_ANON_KEY=tu-anon-key-aqui

# Nuevas variables para Auth (opcional)
VITE_GOOGLE_CLIENT_ID=tu-google-client-id
VITE_GITHUB_CLIENT_ID=tu-github-client-id
```

---

## üìã Paso 4: Implementar Autenticaci√≥n en el C√≥digo

### 4.1 Crear Servicio de Autenticaci√≥n

Crea `src/services/authService.js`:

```javascript
import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

class AuthService {
  // Login con email/password
  async login(email, password) {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) throw error;
    return data;
  }

  // Signup con email/password
  async signup(email, password, displayName) {
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        data: {
          display_name: displayName
        }
      }
    });
    
    if (error) throw error;
    return data;
  }

  // Login con proveedor social (Google, GitHub)
  async loginWithProvider(provider) {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider,
      options: {
        redirectTo: window.location.origin
      }
    });
    
    if (error) throw error;
    return data;
  }

  // Logout
  async logout() {
    const { error } = await supabase.auth.signOut();
    if (error) throw error;
  }

  // Obtener usuario actual
  async getCurrentUser() {
    const { data: { user } } = await supabase.auth.getUser();
    return user;
  }

  // Escuchar cambios de autenticaci√≥n
  onAuthStateChange(callback) {
    return supabase.auth.onAuthStateChanged(callback);
  }
}

export const authService = new AuthService();
export default authService;
```

### 4.2 Hook de Autenticaci√≥n

Crea `src/hooks/useAuth.js`:

```javascript
import { useState, useEffect } from 'react';
import authService from '../services/authService';

export function useAuth() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // Obtener usuario inicial
    authService.getCurrentUser().then(user => {
      setUser(user);
      setLoading(false);
    });

    // Escuchar cambios
    const { data: { subscription } } = authService.onAuthStateChange((event, session) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });

    return () => subscription?.unsubscribe();
  }, []);

  const login = async (email, password) => {
    const { user } = await authService.login(email, password);
    setUser(user);
  };

  const signup = async (email, password, displayName) => {
    const { user } = await authService.signup(email, password, displayName);
    setUser(user);
  };

  const loginWithProvider = async (provider) => {
    await authService.loginWithProvider(provider);
  };

  const logout = async () => {
    await authService.logout();
    setUser(null);
  };

  return {
    user,
    loading,
    isAuthenticated: !!user,
    login,
    signup,
    loginWithProvider,
    logout
  };
}
```

### 4.3 Integrar en App.jsx

```javascript
import { useAuth } from './hooks/useAuth';
import AuthModal from './components/AuthModal';

function App() {
  const { user, loading, isAuthenticated, login, signup, loginWithProvider, logout } = useAuth();
  const [showAuthModal, setShowAuthModal] = useState(false);
  
  // ... resto del c√≥digo

  // Modificar handleCreateSession
  const handleCreateSession = async () => {
    // ‚úÖ VERIFICAR AUTENTICACI√ìN PRIMERO
    if (!isAuthenticated) {
      setShowAuthModal(true);
      return;
    }

    // Continuar con creaci√≥n de sesi√≥n...
    setShowSessionManager(true);
  };

  return (
    <>
      {/* Modal de Autenticaci√≥n */}
      <AuthModal
        isOpen={showAuthModal}
        onClose={() => setShowAuthModal(false)}
        onAuthSuccess={async (authData) => {
          if (authData.mode === 'login') {
            await login(authData.email, authData.password);
          } else if (authData.mode === 'signup') {
            await signup(authData.email, authData.password, authData.displayName);
          } else if (authData.mode === 'social') {
            await loginWithProvider(authData.provider);
          }
        }}
      />

      {/* Resto de la app... */}
    </>
  );
}
```

---

## üìã Paso 5: Modificar CollaborationService

### 5.1 Actualizar M√©todos

```javascript
// En src/services/collaborationService.js

class CollaborationService {
  // ... c√≥digo existente

  // üî• NUEVO: Crear sesi√≥n con archivos en DATABASE
  async createSession(sessionData) {
    const user = await authService.getCurrentUser();
    if (!user) throw new Error('Debes iniciar sesi√≥n primero');

    const sessionCode = this.generateSessionCode();

    // 1. Crear sesi√≥n en database
    const { data: session, error: sessionError } = await this.supabase
      .from('collaborative_sessions')
      .insert({
        session_code: sessionCode,
        session_name: sessionData.sessionName,
        owner_user_id: user.id,
        owner_name: user.user_metadata?.display_name || user.email,
        access_control: sessionData.accessControl,
        password_hash: sessionData.password ? await this.hashPassword(sessionData.password) : null
      })
      .select()
      .single();

    if (sessionError) throw sessionError;

    // 2. Agregar owner como participante
    await this.supabase
      .from('session_participants')
      .insert({
        session_id: session.id,
        user_id: user.id,
        user_name: user.user_metadata?.display_name || user.email,
        user_email: user.email,
        user_color: this.getRandomColor(),
        role: 'owner'
      });

    // 3. üî• Guardar archivos en DATABASE (no localStorage)
    if (sessionData.files) {
      const filesArray = Object.entries(sessionData.files).map(([path, file]) => ({
        session_id: session.id,
        file_path: path,
        content: file.content,
        language: file.language,
        file_type: file.type,
        last_modified_by: user.id,
        last_modified_by_name: user.user_metadata?.display_name || user.email
      }));

      await this.supabase
        .from('workspace_files')
        .insert(filesArray);
    }

    // 4. Conectar al canal Realtime
    await this.connectToChannel(session.id);

    return {
      sessionId: sessionCode,
      shareLink: `${window.location.origin}?session=${sessionCode}`
    };
  }

  // üî• NUEVO: Unirse a sesi√≥n con auth
  async joinSession(sessionCode, userData) {
    const user = await authService.getCurrentUser();
    if (!user) throw new Error('Debes iniciar sesi√≥n primero');

    // 1. Buscar sesi√≥n
    const { data: session, error } = await this.supabase
      .from('collaborative_sessions')
      .select('*')
      .eq('session_code', sessionCode)
      .eq('is_active', true)
      .single();

    if (error || !session) throw new Error('Sesi√≥n no encontrada');

    // 2. Verificar contrase√±a si es privada
    if (session.access_control === 'private' && userData.password) {
      const isValid = await this.verifyPassword(userData.password, session.password_hash);
      if (!isValid) throw new Error('Contrase√±a incorrecta');
    }

    // 3. Agregar como participante
    await this.supabase
      .from('session_participants')
      .insert({
        session_id: session.id,
        user_id: user.id,
        user_name: user.user_metadata?.display_name || user.email,
        user_email: user.email,
        user_color: this.getRandomColor(),
        role: 'editor'
      });

    // 4. Cargar archivos desde DATABASE
    const { data: files } = await this.supabase
      .from('workspace_files')
      .select('*')
      .eq('session_id', session.id);

    // 5. Convertir a formato local
    const filesObject = {};
    files.forEach(file => {
      filesObject[file.file_path] = {
        name: file.file_path.split('/').pop(),
        type: file.file_type,
        language: file.language,
        content: file.content
      };
    });

    // 6. Conectar al canal
    await this.connectToChannel(session.id);

    return { files: filesObject };
  }

  // üî• NUEVO: Guardar cambio en DATABASE
  async broadcastFileChange(filePath, content, cursorPosition, version) {
    const user = await authService.getCurrentUser();
    if (!user) return;

    // 1. Actualizar en DATABASE
    const { error } = await this.supabase
      .from('workspace_files')
      .upsert({
        session_id: this.currentSession.id,
        file_path: filePath,
        content: content,
        version: version,
        last_modified_by: user.id,
        last_modified_by_name: user.user_metadata?.display_name || user.email,
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'session_id,file_path'
      });

    if (error) console.error('Error al guardar en DB:', error);

    // 2. Broadcast a otros usuarios
    await this.channel.send({
      type: 'broadcast',
      event: 'file-change',
      payload: {
        userId: user.id,
        userName: user.user_metadata?.display_name || user.email,
        filePath,
        content,
        version,
        timestamp: Date.now()
      }
    });
  }
}
```

---

## üéØ Flujo Completo

### Usuario A (Owner) Crea Sesi√≥n

```
1. Clic en "Colaborar"
   ‚Üì
2. ¬øAutenticado?
   ‚ùå ‚Üí Mostrar AuthModal ‚Üí Login/Signup
   ‚úÖ ‚Üí Continuar
   ‚Üì
3. Modal "Crear Sesi√≥n"
   ‚Üì
4. createSession()
   ‚îú‚îÄ INSERT en collaborative_sessions
   ‚îú‚îÄ INSERT en session_participants (owner)
   ‚îú‚îÄ INSERT en workspace_files (todos los archivos)
   ‚îî‚îÄ Conectar a canal Realtime
   ‚Üì
5. ‚úÖ Sesi√≥n creada - Compartir link
```

### Usuario B Se Une

```
1. Abre link: ?session=76ec5
   ‚Üì
2. ¬øAutenticado?
   ‚ùå ‚Üí Mostrar AuthModal ‚Üí Login/Signup
   ‚úÖ ‚Üí Continuar
   ‚Üì
3. joinSession('76ec5')
   ‚îú‚îÄ SELECT collaborative_sessions
   ‚îú‚îÄ Verificar contrase√±a (si privada)
   ‚îú‚îÄ INSERT en session_participants
   ‚îú‚îÄ SELECT workspace_files (cargar desde DB)
   ‚îî‚îÄ Conectar a canal Realtime
   ‚Üì
4. ‚úÖ Archivos cargados desde DATABASE
5. ‚úÖ Editor sincronizado con Usuario A
```

### Edici√≥n en Tiempo Real

```
Usuario A escribe "H"
   ‚Üì
broadcastFileChange()
   ‚îú‚îÄ UPDATE workspace_files (DATABASE) ‚úÖ
   ‚îî‚îÄ Broadcast event a Supabase Realtime
       ‚Üì
Usuario B recibe broadcast
   ‚Üì
SELECT workspace_files (DATABASE) ‚úÖ
   ‚Üì
Aplicar contenido al editor
   ‚Üì
‚úÖ Usuario B ve "H" inmediatamente
```

---

## ‚úÖ Beneficios del Nuevo Sistema

| Caracter√≠stica | Antes (Broadcasting) | Ahora (Database) |
|----------------|---------------------|------------------|
| Fuente de verdad | ‚ùå M√∫ltiples (localStorage) | ‚úÖ Una (Supabase DB) |
| Persistencia | ‚ùå Solo local | ‚úÖ Servidor |
| Autenticaci√≥n | ‚ùå No | ‚úÖ Obligatoria |
| Seguridad | ‚ùå B√°sica | ‚úÖ RLS + Auth |
| Sincronizaci√≥n | ‚ùå Broadcast | ‚úÖ DB + Realtime |
| Historial | ‚ùå No | ‚úÖ S√≠ (file_changes_log) |
| Offline | ‚ùå Desincronizado | ‚úÖ Se sincroniza al reconectar |
| Conflictos | ‚ùå Posibles | ‚úÖ Versionado optimista |

---

## üß™ Pruebas

### Prueba 1: Autenticaci√≥n

1. Usuario A: Clic en "Colaborar"
2. Modal de login aparece
3. Signup con email/password
4. ‚úÖ Redirige a crear sesi√≥n

### Prueba 2: Crear Sesi√≥n

1. Crear sesi√≥n "Proyecto X"
2. Verificar en Supabase ‚Üí Table Editor ‚Üí collaborative_sessions
3. ‚úÖ Sesi√≥n creada con archivos en workspace_files

### Prueba 3: Unirse

1. Usuario B: Pegar link
2. Login (o signup)
3. ‚úÖ Archivos cargados desde DATABASE
4. ‚úÖ Mismo contenido que Usuario A

### Prueba 4: Edici√≥n Simult√°nea

1. Usuario A escribe "Hola"
2. ‚úÖ Se guarda en workspace_files
3. ‚úÖ Usuario B lo ve inmediatamente
4. Usuario B escribe "Mundo"
5. ‚úÖ Usuario A lo ve
6. ‚úÖ Ambos ven "Hola Mundo"

---

## üéâ Resumen

**Arquitectura Anterior**:
- ‚ùå localStorage individual
- ‚ùå Solo broadcasting
- ‚ùå Sin autenticaci√≥n
- ‚ùå Sin persistencia

**Arquitectura Nueva**:
- ‚úÖ Single Source of Truth (Supabase DB)
- ‚úÖ Autenticaci√≥n obligatoria
- ‚úÖ Persistencia en servidor
- ‚úÖ Historial de cambios
- ‚úÖ Seguridad con RLS
- ‚úÖ Versionado optimista

**Tu hip√≥tesis era 100% correcta** üéØ

Con este sistema, todos los usuarios editan **exactamente los mismos archivos** almacenados en la base de datos, como Google Docs.
